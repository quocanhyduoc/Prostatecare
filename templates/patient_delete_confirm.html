{% extends "base.html" %}

{% block title %}Xác nhận xóa bệnh nhân - {{ patient.full_name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Warning Header -->
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Cảnh báo: Xóa Bệnh nhân
                    </h4>
                </div>
                
                <div class="card-body">
                    <!-- Patient Information -->
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-user me-2"></i>Thông tin bệnh nhân sẽ bị xóa:</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Họ tên:</strong> {{ patient.full_name }}</p>
                                <p class="mb-1"><strong>Mã BN:</strong> {{ patient.patient_code }}</p>
                                <p class="mb-1"><strong>NSinh:</strong> {{ patient.date_of_birth.strftime('%d/%m/%Y') }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Điện thoại:</strong> {{ patient.phone or 'Không có' }}</p>
                                <p class="mb-1"><strong>Email:</strong> {{ patient.email or 'Không có' }}</p>
                                <p class="mb-1"><strong>Ngày tạo:</strong> {{ patient.created_at.strftime('%d/%m/%Y') if patient.created_at else 'Không có thông tin' }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Related Data Count -->
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-database me-2"></i>Dữ liệu liên quan sẽ bị xóa vĩnh viễn:</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li>
                                        <i class="fas fa-vial text-primary me-2"></i>
                                        <strong>{{ related_data.blood_tests }}</strong> kết quả xét nghiệm máu
                                    </li>
                                    <li>
                                        <i class="fas fa-pills text-success me-2"></i>
                                        <strong>{{ related_data.treatments }}</strong> phác đồ điều trị
                                    </li>
                                    <li>
                                        <i class="fas fa-calendar-alt text-info me-2"></i>
                                        <strong>{{ related_data.appointments }}</strong> lịch hẹn
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li>
                                        <i class="fas fa-clipboard-list text-warning me-2"></i>
                                        <strong>{{ related_data.events }}</strong> sự kiện y tế
                                    </li>
                                    <li>
                                        <i class="fas fa-exclamation-circle text-danger me-2"></i>
                                        <strong>{{ related_data.adverse_events }}</strong> biến cố bất lợi
                                    </li>
                                    <li>
                                        <i class="fas fa-file-medical text-secondary me-2"></i>
                                        Tất cả hình ảnh và tài liệu
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Legal Warning -->
                    <div class="alert alert-dark">
                        <h6><i class="fas fa-gavel me-2"></i>Lưu ý pháp lý:</h6>
                        <ul class="mb-0 small">
                            <li>Việc xóa hồ sơ bệnh án có thể vi phạm quy định lưu trữ hồ sơ y tế</li>
                            <li>Nên cân nhắc "vô hiệu hóa" thay vì xóa hoàn toàn</li>
                            <li>Đảm bảo đã sao lưu dữ liệu cần thiết trước khi xóa</li>
                            <li>Hành động này không thể hoàn tác</li>
                        </ul>
                    </div>

                    <!-- Admin Confirmation -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-shield-alt me-2"></i>Xác thực Admin:</h6>
                        <p class="mb-1">Người thực hiện: <strong>{{ current_user.full_name }}</strong></p>
                        <p class="mb-0">Vai trò: <span class="badge bg-danger">{{ current_user.role.upper() }}</span></p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <form method="POST" action="{{ url_for('patient_delete', patient_id=patient.id) }}" 
                                  onsubmit="return confirm('BẠN CÓ CHẮC CHẮN MUỐN XÓA? Hành động này không thể hoàn tác!');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token._value }}">
                                <button type="submit" class="btn btn-danger btn-lg w-100">
                                    <i class="fas fa-trash-alt me-2"></i>
                                    XÁC NHẬN XÓA VĨNH VIỄN
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <a href="{{ url_for('patient_detail', patient_id=patient.id) }}" 
                               class="btn btn-secondary btn-lg w-100">
                                <i class="fas fa-times me-2"></i>
                                Hủy bỏ
                            </a>
                        </div>
                    </div>

                    <!-- Alternative Options -->
                    <hr class="my-4">
                    <div class="text-center">
                        <h6 class="text-muted">Các lựa chọn thay thế:</h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-warning btn-sm" disabled>
                                <i class="fas fa-eye-slash me-1"></i>
                                Ẩn bệnh nhân (Tính năng sắp có)
                            </button>
                            <a href="{{ url_for('patient_report_pdf', patient_id=patient.id) }}" 
                               class="btn btn-outline-success btn-sm" target="_blank">
                                <i class="fas fa-download me-1"></i>
                                Tải báo cáo trước khi xóa
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.alert {
    border-left: 4px solid;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-danger {
    border-left-color: #dc3545;
}

.alert-dark {
    border-left-color: #495057;
}

.alert-info {
    border-left-color: #0dcaf0;
}

.btn-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.5rem 1rem rgba(220, 53, 69, 0.3);
}

.btn-secondary:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.5rem 1rem rgba(108, 117, 125, 0.3);
}

@media (max-width: 768px) {
    .col-md-6 {
        margin-bottom: 1rem;
    }
    
    .btn-lg {
        font-size: 1rem;
        padding: 0.75rem 1rem;
    }
}

/* Animation cho warning */
@keyframes pulse-warning {
    0% { background-color: rgba(255, 193, 7, 0.1); }
    50% { background-color: rgba(255, 193, 7, 0.2); }
    100% { background-color: rgba(255, 193, 7, 0.1); }
}

.alert-warning {
    animation: pulse-warning 2s infinite;
}
</style>

<script>
$(document).ready(function() {
    // Auto-focus on cancel button for safety
    $('.btn-secondary').focus();
    
    // Add extra confirmation for delete
    $('form').on('submit', function(e) {
        const patientName = '{{ patient.full_name }}';
        const confirmation = confirm(
            `CẢNH BÁO CUỐI CÙNG!\n\n` +
            `Bạn sắp xóa vĩnh viễn bệnh nhân: ${patientName}\n` +
            `Tất cả dữ liệu liên quan sẽ bị mất không thể phục hồi.\n\n` +
            `Gõ "XÓA" để xác nhận:`
        );
        
        if (!confirmation) {
            e.preventDefault();
            return false;
        }
        
        // Show loading state
        $(this).find('button[type="submit"]')
               .html('<i class="fas fa-spinner fa-spin me-2"></i>Đang xóa...')
               .prop('disabled', true);
    });
    
    // Disable delete button initially for 3 seconds
    const deleteBtn = $('.btn-danger');
    deleteBtn.prop('disabled', true)
             .html('<i class="fas fa-clock me-2"></i>Chờ 3 giây...');
    
    let countdown = 3;
    const timer = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            deleteBtn.html(`<i class="fas fa-clock me-2"></i>Chờ ${countdown} giây...`);
        } else {
            clearInterval(timer);
            deleteBtn.prop('disabled', false)
                     .html('<i class="fas fa-trash-alt me-2"></i>XÁC NHẬN XÓA VĨNH VIỄN');
        }
    }, 1000);
});
</script>
{% endblock %}